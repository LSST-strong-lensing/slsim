name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

# Avoid overlapping runs fighting over the cache
concurrency:
  group: ci-${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]

    # Put testmon DB in a stable, cacheable location
    env:
      TESTMON_DATAFILE: .cache/testmon/data.sqlite

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          # Also caches pip wheels for faster installs
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r test_requirements.txt
          python -m pip install flake8 pytest pytest-cov coveralls pytest-testmon codecov
          python -m pip install .

      - name: Prepare testmon directory
        run: mkdir -p .cache/testmon

      - name: Restore testmon cache
        uses: actions/cache@v4
        with:
          path: |
            .testmondata
            .testmondata.bak
            .testmon/
            .cache/testmon/
          # Keyed by OS + Py + branch-name + dependency hash
          key: testmon-${{ runner.os }}-py${{ matrix.python-version }}-${{ github.head_ref || github.ref_name }}-${{ hashFiles('**/pyproject.toml', '**/setup.cfg', '**/setup.py', '**/requirements*.txt', 'poetry.lock', 'uv.lock') }}
          restore-keys: |
            testmon-${{ runner.os }}-py${{ matrix.python-version }}-${{ github.head_ref || github.ref_name }}-
            testmon-${{ runner.os }}-py${{ matrix.python-version }}-

      - name: Run tests (incremental with testmon)
        run: pytest --testmon --cov=./ --cov-report=xml

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v3
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          files: ./coverage.xml

      # - name: Upload coverage.xml
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: coverage-${{ matrix.python-version }}
      #     path: coverage.xml
