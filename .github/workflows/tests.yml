- uses: actions/checkout@v4

- name: Set up Python
  uses: actions/setup-python@v5
  with:
    python-version: ${{ matrix.python-version }}

# (optional) keep pip cache too for speed
- name: Cache pip
  uses: actions/cache@v4
  with:
    path: ~/.cache/pip
    key: pip-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml', '**/setup.cfg', '**/setup.py', 'requirements*.txt') }}
    restore-keys: |
      pip-${{ runner.os }}-py${{ matrix.python-version }}-

- name: Install deps
  run: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt
    # ensure testmon is present; remove if already in your reqs
    pip install pytest-testmon

# (optional but tidy)
- name: Configure testmon path
  run: |
    mkdir -p .cache/testmon
    echo "TESTMON_DATAFILE=.cache/testmon/data.sqlite" >> $GITHUB_ENV

- name: Restore testmon cache
  uses: actions/cache@v4
  with:
    path: |
      .testmondata
      .testmondata.bak
      .testmon/
      .cache/testmon/
    key: testmon-${{ runner.os }}-py${{ matrix.python-version }}-${{ github.ref_name }}-${{ hashFiles('**/pyproject.toml', '**/setup.cfg', '**/setup.py', 'requirements*.txt') }}
    restore-keys: |
      testmon-${{ runner.os }}-py${{ matrix.python-version }}-${{ github.ref_name }}-
      testmon-${{ runner.os }}-py${{ matrix.python-version }}-

- name: Run tests (incremental)
  run: |
    pytest --testmon --cov=./ --cov-report=xml
